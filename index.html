<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS ליקוט חכם</title>
    <link rel="stylesheet" href="styles.css?v=18">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- ========== מסך כניסה ========== -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">📦</div>
            <h1 class="login-title">WMS ליקוט חכם</h1>
            <p class="login-subtitle">הזן סיסמה להתחברות</p>
            <form id="loginForm">
                <div class="login-input-group">
                    <input type="password" id="passwordInput" placeholder="סיסמה" required autocomplete="off">
                </div>
                <button type="submit" class="btn btn-primary btn-large login-btn">
                    🔓 כניסה
                </button>
                <p class="login-error hidden" id="loginError">סיסמה שגויה</p>
            </form>
        </div>
    </div>

    <!-- ========== אפליקציה ראשית ========== -->
    <div class="app-container hidden" id="appContainer">
        <!-- ========== תפריט עליון ========== -->
        <header class="top-nav">
            <a href="#" class="logo" onclick="location.reload()">
                <span class="logo-icon">📦</span>
                <span class="logo-text">WMS ליקוט חכם</span>
            </a>
            <nav class="nav-links">
                <a href="#" class="nav-link active" data-screen="orders-dashboard">לוח הזמנות</a>
                <a href="#" class="nav-link" data-screen="management-hub">ניהול</a>
                <button class="btn btn-print" id="printCartonsBtn" style="display: none;">
                    🖨️ הדפס קרטונים
                </button>
                <button class="btn btn-secondary btn-small" id="logoutBtn">
                    🚪 יציאה
                </button>
            </nav>
        </header>

        <!-- ========== מסך ראשי - לוח הזמנות ========== -->
        <main class="screen" id="orders-dashboard">
            <div class="screen-header">
                <h1>לוח הזמנות</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="importExcelBtn">
                        📁 ייבוא מ-Excel
                    </button>
                    <button class="btn btn-primary" id="newOrderBtn">
                        <span>+</span> הזמנה חדשה
                    </button>
                </div>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display:none;">
            </div>

            <div class="table-container">
                <table class="data-table" id="ordersTable">
                    <thead>
                        <tr>
                            <th>מס' הזמנה</th>
                            <th>לקוח</th>
                            <th>כתובת</th>
                            <th>קו חלוקה</th>
                            <th>פריטים</th>
                            <th>קרטונים</th>
                            <th>סטטוס</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- הזמנות יוזנו דינמית -->
                    </tbody>
                </table>
                <div class="empty-state" id="ordersEmptyState">
                    <div class="empty-icon">📋</div>
                    <p>אין הזמנות עדיין</p>
                    <p class="empty-hint">לחץ על "הזמנה חדשה" כדי להתחיל</p>
                </div>
            </div>
        </main>

        <!-- ========== טופס יצירת/עריכת הזמנה ========== -->
        <main class="screen hidden" id="order-form">
            <div class="screen-header">
                <h1 id="orderFormTitle">יצירת הזמנה חדשה</h1>
                <button class="btn btn-secondary" id="cancelOrderBtn">ביטול וחזרה</button>
            </div>

            <form class="order-form" id="orderFormElement">
                <input type="hidden" id="editingOrderId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="customerName">שם לקוח *</label>
                        <input type="text" id="customerName" required placeholder="הכנס שם לקוח">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="deliveryAddress">כתובת למשלוח</label>
                        <input type="text" id="deliveryAddress" placeholder="כתובת (אופציונלי)">
                    </div>
                    <div class="form-group">
                        <label for="deliveryLine">קו חלוקה</label>
                        <input type="text" id="deliveryLine" placeholder="ליין משלוחים (אופציונלי)">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="productsList">רשימת מוצרים *</label>
                    <textarea id="productsList" rows="8" required
                        placeholder="הדבק רשימת מוצרים בפורמט:&#10;מק״ט, כמות&#10;מק״ט, כמות&#10;..."></textarea>
                    <small class="form-hint">פורמט: מק"ט, כמות (כל מוצר בשורה נפרדת)</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success btn-large">
                        💾 שמור והפק קרטונים
                    </button>
                </div>
            </form>
        </main>

        <!-- ========== מסך תוצאות - כרטיסי קרטון ========== -->
        <main class="screen hidden" id="results-view">
            <div class="screen-header">
                <button class="btn btn-secondary" id="backToOrdersBtn">← חזרה ללוח ההזמנות</button>
                <h1 id="resultsTitle">תוצאות הזמנה</h1>
            </div>

            <!-- כותרת עליונה עם נתוני ההזמנה -->
            <div class="results-header-bar" id="resultsHeaderBar">
                <!-- ימולא דינמית -->
            </div>

            <!-- כפתור הדפסה גדול -->
            <div class="results-print-action">
                <button class="btn btn-primary btn-xlarge" id="printAllCartonsBtn" onclick="window.print()">
                    🖨️ הדפסת מדבקות להזמנה
                </button>
            </div>

            <div class="results-summary" id="resultsSummary" style="display: none;">
                <!-- סיכום קרטונים - מוסתר, הנתונים עברו לכותרת -->
            </div>

            <div class="cartons-grid" id="cartonsGrid">
                <!-- כרטיסי קרטון -->
            </div>
        </main>

        <!-- ========== מרכז הניהול ========== -->
        <main class="screen hidden" id="management-hub">
            <div class="screen-header">
                <h1>מרכז ניהול</h1>
            </div>

            <div class="hub-tiles">
                <div class="hub-tile" data-panel="products-management">
                    <div class="tile-icon">📦</div>
                    <h3>ניהול מוצרים</h3>
                    <p>הוספה, עריכה ומחיקה של מוצרים</p>
                </div>

                <div class="hub-tile" data-panel="carton-types">
                    <div class="tile-icon">📐</div>
                    <h3>סוגי קרטונים</h3>
                    <p>הגדרת גדלים ונפחים</p>
                </div>

                <div class="hub-tile" data-panel="visual-map">
                    <div class="tile-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none"
                            stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3v18h18" />
                            <path d="M3 9h18" />
                            <path d="M3 15h18" />
                            <path d="M9 3v18" />
                        </svg>
                    </div>
                    <h3>ניהול ליינים</h3>
                    <p>מיקום מוצרים בליינים</p>
                </div>

                <div class="hub-tile" data-panel="orders-management">
                    <div class="tile-icon">📝</div>
                    <h3>ניהול הזמנות</h3>
                    <p>עריכה ומחיקה של הזמנות</p>
                </div>

                <div class="hub-tile" onclick="showScreen('user-manual')"
                    style="border: 2px solid #4CAF50; background: #e8f5e9; cursor: pointer;">
                    <div class="tile-icon">📚</div>
                    <h3>הסבר וניווט באתר</h3>
                    <p>מדריך מלא למשתמש - איך להשתמש במערכת</p>
                </div>

                <div class="hub-tile" onclick="window.generatePassoverData()"
                    style="border: 2px dashed #4CAF50; background: #e8f5e9;">
                    <div class="tile-icon">🫓</div>
                    <h3>הוספת פרטי פסח לדוגמא</h3>
                    <p>טוען 400 מוצרים ב-20 מחלקות</p>
                </div>

                <div class="hub-tile"
                    onclick="if(window.startMockOrders) window.startMockOrders(); else alert('טוען נתונים... אנא המתן ונסה שוב')"
                    style="border: 2px dashed #2196F3; background: #e3f2fd; cursor: pointer;">
                    <div class="tile-icon">📑</div>
                    <h3>צור עומס הזמנות לבדיקה</h3>
                    <p>80 הזמנות, 170 פריטים כ"א</p>
                </div>

                <div class="hub-tile" id="deleteAllDataBtn" onclick="confirmDeleteAllData()"
                    style="border: 2px dashed #f44336; background: #ffebee; cursor: pointer;">
                    <div class="tile-icon">⚠️</div>
                    <h3>מחיקת כל הנתונים</h3>
                    <p>מנקה את כל המוצרים, הזמנות וליינים</p>
                </div>
            </div>
        </main>

        <!-- ========== פאנל ניהול מוצרים ========== -->
        <main class="screen hidden" id="products-management">
            <div class="screen-header">
                <button class="btn btn-secondary" onclick="showScreen('management-hub')">← חזרה לניהול</button>
                <h1>ניהול מוצרים</h1>
                <button class="btn btn-primary" id="addProductBtn">+ הוסף מוצר</button>
            </div>

            <div class="filters-bar">
                <input type="text" id="productSearch" placeholder="🔍 חיפוש לפי שם או מק״ט...">
                <select id="beltFilter">
                    <option value="">כל הליינים</option>
                </select>
            </div>

            <div class="table-container">
                <table class="data-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>מק"ט</th>
                            <th>שם מוצר</th>
                            <th>נפח (סמ"ק)</th>
                            <th>ליין</th>
                            <th>מיקום</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    </tbody>
                </table>
            </div>
        </main>

        <!-- ========== פאנל סוגי קרטונים ========== -->
        <main class="screen hidden" id="carton-types">
            <div class="screen-header">
                <button class="btn btn-secondary" onclick="showScreen('management-hub')">← חזרה לניהול</button>
                <h1>סוגי קרטונים</h1>
                <button class="btn btn-primary" id="addCartonTypeBtn">+ הוסף סוג קרטון</button>
            </div>

            <div class="table-container">
                <table class="data-table" id="cartonTypesTable">
                    <thead>
                        <tr>
                            <th>שם</th>
                            <th>נפח מקסימלי (סמ"ק)</th>
                            <th>משקל מקסימלי (ק"ג)</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="cartonTypesTableBody">
                    </tbody>
                </table>
            </div>
        </main>

        <!-- ========== ניהול ליינים ========== -->
        <main class="screen hidden" id="visual-map">
            <div class="screen-header">
                <button class="btn btn-secondary" onclick="showScreen('management-hub')">← חזרה לניהול</button>
                <h1>ניהול ליינים - מיקום מוצרים</h1>
            </div>

            <div class="warehouse-map" id="warehouseMap">
                <!-- טורי הליינים יווצרו דינמית -->
            </div>
        </main>

        <!-- ========== פאנל ניהול הזמנות ========== -->
        <main class="screen hidden" id="orders-management">
            <div class="screen-header">
                <button class="btn btn-secondary" onclick="showScreen('management-hub')">← חזרה לניהול</button>
                <h1>ניהול הזמנות</h1>
                <button class="btn btn-primary" onclick="recalculateAllCartons()">🔄 חישוב קרטונים מחדש</button>
            </div>

            <div class="table-container">
                <table class="data-table" id="ordersManagementTable">
                    <thead>
                        <tr>
                            <th>מס' הזמנה</th>
                            <th>לקוח</th>
                            <th>תאריך</th>
                            <th>סטטוס</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="ordersManagementTableBody">
                    </tbody>
                </table>
            </div>
        </main>

        <!-- ========== מדריך למשתמש ========== -->
        <main class="screen hidden" id="user-manual">
            <div class="screen-header">
                <button class="btn btn-secondary" onclick="showScreen('management-hub')">← חזרה לניהול</button>
                <h1>מדריך למשתמש</h1>
            </div>

            <div class="manual-container"
                style="max-width: 900px; margin: 0 auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">

                <h2 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;">1. מסך הבית (Dashboard)
                </h2>
                <ul style="list-style-type: none; padding: 0;">
                    <li style="margin-bottom: 15px;">
                        <strong>🟦 הוסף הזמנה חדשה (כפתור כחול גדול)</strong><br>
                        כניסה למסך יצירת הזמנה חדשה וחישוב קרטונים.
                    </li>
                    <li style="margin-bottom: 15px;">
                        <strong>📦 ניהול מוצרים</strong><br>
                        צפייה בכל המוצרים, הוספה ידנית, עריכת פרטים (מק"ט, נפח, ליין).
                    </li>
                    <li style="margin-bottom: 15px;">
                        <strong>📏 סוגי קרטונים</strong><br>
                        הגדרת גדלי הקרטונים הקיימים במלאי (S, M, XL וכו').
                    </li>
                    <li style="margin-bottom: 15px;">
                        <strong>🏗️ ניהול ליינים</strong><br>
                        תצוגה ויזואלית של המחסן וסידור מוצרים בליינים.
                    </li>
                    <li style="margin-bottom: 15px;">
                        <strong>📝 ניהול הזמנות</strong><br>
                        היסטוריית הזמנות, הדפסה חוזרת ומחיקה. חישוב מחדש של כל ההזמנות.
                    </li>
                </ul>

                <h2 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px;">2.
                    יצירת הזמנה</h2>
                <p>מדביקים נתונים מאקסל בתיבה הגדולה ולוחצים על <strong>"נתח הזמנה וחשב קרטונים"</strong>.</p>

                <h2 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px;">3.
                    הדפסה 🖨️</h2>
                <p>לוחצים על סמל המדפסת במסך התוצאות. המערכת תדפיס בפורמט נקי (שחור-לבן).<br>
                    אם קרטון מכיל מעל <strong>11 פריטים</strong>, הוא יפוצל אוטומטית למספר עמודים עם הודעת אזהרה "עמוד X
                    מתוך Y".</p>

                <h2 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px;">4.
                    ניהול מלאי וסנכרון</h2>
                <ul>
                    <li><strong>במפה הויזואלית:</strong> לחיצה על קוביית מוצר פותחת תפריט להעברה מהירה לליין אחר או
                        שינוי מיקום.</li>
                    <li><strong>סנכרון אוטומטי:</strong> כל שינוי במוצר (בטבלה או במפה) מתעדכן מיד בכל המערכת ללא צורך
                        ברענון.</li>
                </ul>

                <div
                    style="background: #e8f5e9; border: 1px solid #4CAF50; padding: 15px; border-radius: 5px; margin-top: 30px;">
                    <strong>🔄 חישוב קרטונים מחדש:</strong><br>
                    כפתור במסך "ניהול הזמנות". השתמש בו רק אם שינית את מידות הקרטונים (במסך סוגי קרטונים) ואתה רוצה
                    לעדכן את כל ההזמנות הישנות לגדלים החדשים.
                </div>
                <h2 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px;">🧠
                    איך עובד האלגוריתם? (הסבר טכני)</h2>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-right: 4px solid #3498db;">
                    <p style="margin-top:0">המערכת משתמשת באלגוריתם חכם ("Packing Algorithm") שנועד למזער את ההליכה
                        במחסן. הנה איך הוא חושב:</p>

                    <h3 style="margin-top: 15px; color: #2980b9;">1. מיון וסידור</h3>
                    <p>המחשב לוקח את כל הפריטים ומסדר אותם לפי סדר הליינים (1, 2, 3...). המטרה: שהמלקט לא יצטרך לחזור
                        אחורה.</p>

                    <h3 style="color: #2980b9;">2. אריזה לפי אזורים</h3>
                    <p>האלגוריתם מנסה קודם כל לארוז כל ליין בנפרד. הוא בודק את נפח המוצרים ובוחר את הקרטון הכי מתאים (S,
                        M, XL) כדי לא לבזבז מקום.</p>

                    <h3 style="color: #2980b9;">3. מיזוג חכם</h3>
                    <p>אם בסוף ליין מסוים נשאר קרטון חצי ריק (מתחת ל-75% תפוסה), המחשב "שומר אותו פתוח" ומנסה למזג אותו
                        עם המוצרים של הליין הבא. אם הם נכנסים יחד לקרטון אחד - הם יאוחדו. זה חוסך סחיבת קרטונים עם
                        אוויר.</p>
                </div>
            </div>
        </main>

        <!-- ========== מודל/פופאפ כללי ========== -->
        <div class="modal-overlay hidden" id="modalOverlay">
            <div class="modal" id="modal">
                <div class="modal-header">
                    <h2 id="modalTitle">כותרת</h2>
                    <button class="modal-close" id="modalClose">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- תוכן דינמי -->
                </div>
            </div>
        </div>
    </div>
    <!-- סגירת app-container -->



    <!-- קבצי JavaScript -->
    <!-- קבצי Javascript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="supabase.js?v=17"></script>
    <script src="packing-algorithm.js?v=12"></script>
    <script src="mock_data.js?v=13"></script>
    <script src="app.js?v=23"></script>
</body>

</html>