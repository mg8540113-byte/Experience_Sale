/* ============================================
   WMS ליקוט חכם - מחולל נתוני פסח
   ============================================ */

const PassoverGenerator = {

    categories: [
        { name: "מצות ומוצרי מצה", items: ["מצות שמורות עבודת יד", "מצות מכונה 1קג", "מצות מכונה 2.5קג", "קמח מצה שמור", "קמח מצה רגיל", "קמח מצה עוגות", "מצה עשירה", "עוגיות מצה", "מצות כוסמין", "מצות שיפון", "קמח תפוחי אדמה", "פירורי מצה", "מצות ביצים", "קרקרים כשרים לפסח", "מצות מצופות שוקולד", "מצות קטנות", "תחתיות למצה", "מצות חיטה מלאה", "גליליות כשר לפסח", "וופלים כשר לפסח"] },
        { name: "מוצרי אפייה", items: ["אבקת אפייה כלפ", "סוכר וניל כלפ", "סודה לשתייה", "שוקולד צ'יפס", "קקאו משובח", "פודינג וניל", "פודינג שוקולד", "ג'לי תות", "ג'לי משמש", "תמצית וניל", "תמצית שקדים", "שמרים יבשים (לא לחמץ)", "קורנפלור", "סוכר לבן 1קג", "סוכר חום", "אבקת סוכר", "קוקוס טחון", "שקדים טחונים", "אגוזים טחונים", "מלית פרג"] },
        { name: "שוקולדים וממתקים", items: ["שוקולד מריר 60%", "שוקולד מריר 70%", "שוקולד חלב", "שוקולד לבן", "חטיף קוקוס", "חטיף שוקולד נוגט", "בונבוניירה כלפ", "מרשמלו", "עדשים צבעוניות", "סוכריות גומי", "סוכריות מנטה", "סוכריות על מקל", "טופי פירות", "חלבה וניל", "חלבה עם פולי קקאו", "חטיף בוטנים", "מטבעות שוקולד", "אצבעות שוקולד", "ביצי שוקולד", "ממרח שוקולד עלית"] },
        { name: "חטיפים ונשנושים", items: ["במבה כלפ", "ביסלי (כשר לפסח)", "צ'יפס טבעי", "צ'יפס שמנת בצל", "דובונים", "אפרופו כלפ", "בייגלה כלפ", "פופקורן למיקרו", "גרעינים שחורים", "גרעיני אבטיח", "פיסטוקים קלויים", "בוטנים קלויים", "קשיו קלוי", "שקדים קלויים", "אגוזי לוז", "מיקס פיצוחים", "פריכיות אורז", "פריכיות תירס", "חטיף אנרגיה כלפ", "קרקרים מלוחים"] },
        { name: "שימורים וירקות", items: ["מלפפון במלח", "מלפפון בחומץ (כשר לפסח)", "זיתים ירוקים", "זיתים שחורים", "תירס גמדי", "גרגירי תירס", "אפונה וגזר", "שעועית ירוקה", "רסק עגבניות", "עגבניות מרוסקות", "שימורי פטריות חתוכות", "שימורי פטריות שלמות", "לפתן אפרסק", "לפתן משמש", "לפתן אננס", "דובדבנים מסוכרים", "חצילים בטעם כבד", "סלט מטבוחה", "סלט חצילים במיונז", "חזרת אדומה"] },
        { name: "שמנים ורטבים", items: ["שמן אגוזים", "שמן דקלים", "שמן קנולה (לאוכלי קטניות)", "שמן זית כתית", "חומץ בן יין", "חומץ סינתטי כלפ", "מיונז כלפ", "קטשופ כלפ", "חרדל כלפ", "רוטב צ'ילי מתוק", "רוטב צ'ילי חריף", "רוטב סויה (תחליף)", "רוטב ברביקיו", "רוטב שום", "רוטב אלף האיים", "מיץ לימון משומר", "טחינה גולמית", "טחינה משומשום מלא", "סילאן טבעי", "דבש טהור"] },
        { name: "יין ומשקאות", items: ["תירוש אדום", "תירוש לבן", "יין אדום יבש", "יין אדום מתוק", "יין לבן חצי יבש", "יין רוזה", "מיץ ענבים מוגז", "קוקה קולה כלפ", "ספרייט כלפ", "סודה", "מים מינרלים שישייה", "מיץ תפוזים סחוט", "מיץ תפוחים", "תרכיז פטל", "תרכיז ענבים", "ליקר שוקולד", "ארק", "ברנדי", "וודקה כלפ", "תה קר אפרסק"] },
        { name: "קפה ותה", items: ["קפה נמס עלית", "קפה נמס מגורען", "קפה טורקי שחור", "קפה נטול קפאין", "קפסולות קפה כלפ", "תה רגיל (תיון)", "תה ירוק", "תה נענע", "תה קמומיל", "תה פירות יער", "סוכרזית", "ממתיק סטביה", "שוקולית כלפ", "משקה שקדים (תחליף חלב)", "משקה סויה (קטניות)", "חלב עמיד", "שמנת לקפה", "נס קפה טייסטרס צ'ויס", "תה בתפזורת", "מקלות קינמון"] },
        { name: "תבלינים", items: ["מלח שולחן 1קג", "מלח גס", "פלפל שחור טחון", "פלפל לבן", "פפריקה מתוקה", "פפריקה חריפה", "כמון", "כורכום", "אבקת שום", "שום גבישי", "בצל מיובש", "מרק עוף פרווה", "אבקת מרק בצל", "אבקת מרק פטריות", "זעתר כלפ", "אורגנו", "בזיליקום", "עלי דפנה", "קינמון טחון", "ציפורן"] },
        { name: "חד פעמי - כללי", items: ["צלחות גדולות קשיחות", "צלחות קטנות קשיחות", "קערות מרק 500מל", "כוסות שתיה קרה", "כוסות שתיה חמה", "כוסות יין מהודרות", "סכו\"ם מהודר כסף", "סכו\"ם מהודר זהב", "מזלגות פלסטיק", "כפות פלסטיק", "סכיני פלסטיק", "כפיות", "מפיות שולחן לבנות", "מפיות מעוצבות", "מפת שולחן לבנה", "מפת שולחן מעוצבת", "רנר לשולחן", "גביעי קידוש", "קשיות שתייה", "קיסמי שיניים"] },
        { name: "ניקיון והגיינה", items: ["אקונומיקה 4 ליטר", "נוזל כלים לימון", "נוזל כלים תפוח", "ספוג הפלא", "כרית יפנית", "צמר פלדה", "סבון לרצפה", "מתז חלונות", "מסיר שומנים קר", "תרסיס ניקוי כללי", "נייר סופג", "נייר טואלט 32", "נייר טואלט 48", "מגבונים לחים", "שקיות אשפה ענק", "שקיות אשפה S", "נייר כסף עבה", "נייר אפייה", "ניילון נצמד", "תבניות אלומיניום"] },
        { name: "בשר ודגים (שימורים/קפוא)", items: ["טונה בשמן", "טונה במים", "סרדינים", "מקרל", "סלמון מעושן", "גפילטע פיש בצנצנת", "קבנוס", "נקניק סלמי", "פסטרמה הודו", "שמאלץ (שומן עוף)", "כבד קצוץ", "נקניקיות עוף", "שניצל תירס (קטניות)", "המבורגר קפוא", "קציצות דגים", "פילה מושט קפוא", "פילה סלמון קפוא", "בשר טחון קפוא", "עוף שלם קפוא", "כרעיים עוף"] },
        { name: "מוצרי יסוד נוספים", items: ["אורז פרסי (קטניות)", "אורז יסמין", "אורז מלא", "קינואה", "שעועית יבשה", "עדשים ירוקות", "חומוס גרגירים יבש", "ביצים L", "ביצים XL", "שמן זית פח", "מלח ים אטלנטי", "סוכר דמררה", "דבש לחיץ", "שמן קוקוס", "חומץ תפוחים", "רסק תפוחי עץ", "זיתים ממולאים", "זיתים סורים", "מלפפון חמוץ גדול", "חציל על האש"] },
        { name: "פירות יבשים ואגוזים", items: ["תמרים מג'הול", "תמרים ואקום", "משמש מיובש", "שזיפים מיובשים", "צימוקים לבנים", "צימוקים שחורים", "חמוציות", "אגוזי מלך קלופים", "שקדים מולבנים", "שקדים פרוסים", "אגוזי פקאן", "אגוזי קשיו טבעי", "פיסטוק טבעי", "גרעיני דלעת", "גרעיני חמניה", "תאנים מיובשות", "פאפאיה מסוכר", "אננס מיובש", "בננה צ'יפס", "קוקוס קלוי"] },
        { name: "מוצרי תינוקות", items: ["מטרנה כלפשלב 1", "מטרנה כלפ שלב 2", "מטרנה כלפ שלב 3", "סימילאק כלפ 1", "סימילאק כלפ 2", "דייסת וניל", "דייסת קורנפלור", "ביסקוויטים לתינוק כלפ", "מחית פירות", "מחית ירקות", "בקבוק לתינוק", "מוצצים", "מגבונים לתינוק", "חיתולים מידה 3", "חיתולים מידה 4", "חיתולים מידה 5", "משחת החתלה", "שמפו לתינוק", "סבון לתינוק", "שמן תינוקות"] },
        { name: "כלי בית ובישול", items: ["קולפן ירקות", "פותחן שימורים", "פותחן יין", "תרווד", "מצקת למרק", "כף הגשה", "סכין חיתוך גדולה", "סכין פירות", "קרש חיתוך", "קערת ערבוב", "מסננת", "פומפייה", "כותש שום", "מפצח אגוזים", "מגבת מטבח", "סקוץ' כלים", "כפפות לטקס", "כפפות ניילון", "גפרורים", "נרות שבת"] },
        { name: "מוצרי נייר ואריזה", "items": ["מנג'טים לעוגיות", "תבנית אינגליש קייק", "תבנית עגולה חד פעמית", "תבנית מרובעת גדולה", "נייר סנדוויץ'", "שקיות אוכל", "שקיות הקפאה", "שקיות זיפלוק", "סלוטייפ", "מרקר סימון", "מדבקות למכסה", "גומיות משרד", "שדכן סיכות", "חוט קשירה", "נייר עטיפה למצות", "שקיות נשיאה גופיה", "שקיות בד רב פעמיות", "קופסאות אחסון פלסטיק", "צנצנות זכוכית", "בקבוקי זכוכית ליין"] },
        { name: "מוצרי חלב (קירור)", items: ["חלב תנובה 3%", "חלב תנובה 1%", "חלב בכד 2 ליטר", "שוקו בכד", "שמנת מתוקה להקצפה", "שמנת לבישול", "גבינה לבנה 5%", "גבינה לבנה 9%", "קוטג' 5%", "קוטג' 9%", "גבינה צהובה פרוסה", "גבינה צהובה מגורדת", "חמאה מלוחה", "חמאה רגילה", "יוגורט ביו", "מעדן שוקולד", "מעדן וניל", "גבינת שמנת", "גבינה בולגרית", "גבינת צפתית"] },
        { name: "ירקות ופירות טריים", items: ["תפוחי אדמה לבן", "תפוחי אדמה אדום", "בצל יבש", "בצל סגול", "גזר ארוז", "גזר בתפזורת", "בטטה", "דלעת", "קישואים", "מלפפון", "עגבניה", "פלפל אדום", "פלפל ירוק", "חסה ערבית", "כרוב לבן", "כרוב אדום", "סלק", "תפוח עץ חרמון", "תפוח עץ גרני סמית", "בננות"] },
        { name: "שונות ומיוחדים", items: ["הגדה של פסח", "כיפה לבנה", "כיפה סרוגה", "נרות הבדלה", "סט הבדלה", "כיסוי למצות", "קערת ליל הסדר", "כוס לקידוש", "נטלה לידיים", "ספר מתכונים לפסח", "דיסק שירי פסח", "צעצוע לילדים", "משחק קופסה", "חפיסת קלפים", "כדור משחק", "עט לכתיבה", "פנקס רשימות", "סוללות AA", "סוללות AAA", "נורה להחלפה"] }
    ],

    async generate() {
        if (!confirm('האם אתה בטוח שברצונך ליצור 400 מוצרי פסח ו-20 ליינים? זה עשוי לקחת דקה.')) return;

        console.log('מתחיל יצירת נתונים...');
        let skuCounter = 1000;
        let createdProducts = 0;
        let createdBelts = 0;

        // וידוא שהליינים קיימים
        const existingBelts = await DataManager.getBelts();

        // יצירת ליינים וטעינת מוצרים
        for (let i = 0; i < this.categories.length; i++) {
            const category = this.categories[i];
            const beltNumber = i + 1;

            // בדיקה אם הליין קיים
            let belt = existingBelts.find(b => b.number === beltNumber);
            if (!belt) {
                belt = await DataManager.addBelt({
                    number: beltNumber,
                    name: category.name
                });
                createdBelts++;
                console.log(`נוצר ליין: ${category.name}`);
            } else {
                // עדכון שם הליין אם הוא קיים
                await DataManager.updateBelt(belt.id, { name: category.name });
            }

            // ניקוי מוצרים קיימים בליין זה למניעת כפילויות במיקומים
            const existingProductsInBelt = DataManager.getProductsByBelt(beltNumber);
            for (const p of existingProductsInBelt) {
                await DataManager.deleteProduct(p.id);
            }

            // יצירת מוצרים לליין
            for (let j = 0; j < 20; j++) { // 20 מוצרים לליין
                if (j >= category.items.length) break; // הגנה מחריגה

                const itemName = category.items[j];
                const volume = Math.floor(Math.random() * 1500) + 100; // נפח אקראי 100-1600
                const sku = skuCounter.toString();

                const product = {
                    sku: sku,
                    name: itemName,
                    volume: volume,
                    belt: beltNumber,
                    position: j + 1
                };

                // בדיקה אם המק"ט כבר קיים כדי למנוע כפילויות
                const existingProduct = await DataManager.getProductBySku(sku);
                if (!existingProduct) {
                    await DataManager.addProduct(product);
                    createdProducts++;
                } else {
                    await DataManager.updateProduct(existingProduct.id, product);
                }

                skuCounter++;
            }
        }

        alert(`✅ תהליך הסתיים!\nנוצרו/עודכנו ${createdBelts} ליינים.\nנוצרו/עודכנו ${createdProducts} מוצרים חדשים.\nרענן את הדף לצפייה בשינויים.`);

        // רענון מסכים
        if (typeof refreshProductsTable === 'function') refreshProductsTable();
        if (typeof refreshBeltsTable === 'function') refreshBeltsTable();
        if (typeof refreshVisualMap === 'function') refreshVisualMap();
    },

    async generateOrders() {
        if (!confirm('⚠️ פעולה זו תיצור 80 הזמנות עומס (כ-13,000 פריטים).\nהאם להמשיך?')) return;

        const products = DataManager.getProducts();

        // תיקון: יצירת סוגי קרטונים ברירת מחדל אם אין
        let cartonTypes = DataManager.getCartonTypes();
        if (!cartonTypes || cartonTypes.length === 0) {
            console.log('Creating default carton types...');
            const defaultTypes = [
                { name: 'קרטון קטן (S)', maxVolume: 6000 },
                { name: 'קרטון בינוני (M)', maxVolume: 12000 },
                { name: 'קרטון ענק (XL)', maxVolume: 24000 }
            ];
            for (const type of defaultTypes) {
                await DataManager.addCartonType(type);
            }
            // רענון הרשימה אחרי יצירה
            cartonTypes = DataManager.getCartonTypes();
        }

        if (!products || products.length === 0) {
            alert('❌ אין מוצרים במערכת! אנא צור מוצרים (למשל בעזרת "פרטי פסח") לפני יצירת הזמנות.');
            return;
        }

        console.log('מתחיל יצירת הזמנות עומס...');
        const startTime = Date.now();
        let createdOrders = 0;

        try {
            document.body.style.cursor = 'wait';

            for (let i = 1; i <= 80; i++) {
                const items = [];
                // בחירת 170 פריטים אקראיים (עם משקלים/כמויות)
                for (let j = 0; j < 170; j++) {
                    const randomProduct = products[Math.floor(Math.random() * products.length)];

                    const existingItem = items.find(item => item.sku === randomProduct.sku);
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        items.push({ sku: randomProduct.sku, quantity: 1 });
                    }
                }

                // חישוב אריזה (תיקון: נוסף חישוב בזמן יצירה)
                const cartons = PackingAlgorithm.packOrder(items, products, cartonTypes);

                const order = {
                    orderNumber: 90000 + i, // ספרור מיוחד להזמנות עומס
                    customerName: `לקוח עומס ${i}`,
                    address: `רחוב הבדיקות ${Math.floor(Math.random() * 100)}, עיר המחסנים`,
                    deliveryLine: `קו ${Math.floor(Math.random() * 10) + 1}`,
                    items: items,
                    cartons: cartons, // הוספת הקרטונים שחושבו
                    status: 'חדשה',
                    createdAt: new Date().toISOString()
                };

                // שימוש ישיר ב-DataManager ליעילות
                await DataManager.addOrder(order);
                createdOrders++;

                // עדכון לוג כל 10 הזמנות
                if (i % 10 === 0) console.log(`נוצרו ${i} הזמנות...`);
            }

            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            alert(`✅ הסתיים בהצלחה!\nנוצרו ${createdOrders} הזמנות עומס ב-${duration} שניות.\nעבור למסך "ניהול הזמנות" לצפייה.`);

            if (typeof loadOrders === 'function') loadOrders();

        } catch (error) {
            console.error('Error generating mock orders:', error);
            alert('שגיאה ביצירת הזמנות: ' + error.message);
        } finally {
            document.body.style.cursor = 'default';
        }
    }
};

// הפיכת הפונקציות לזמינות גלובלית
window.generatePassoverData = () => PassoverGenerator.generate();
window.startMockOrders = () => {
    console.log('Starting mock orders generation...');
    PassoverGenerator.generateOrders();
};
